name: Deploy Blackjack to Render

on:
  push:
    branches:
      - main  # 只有推送到 main 分支时触发

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write # 必须开启此权限才能推送镜像

    steps:
      # 1. 拉取代码
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. 登录 GitHub Container Registry
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 3. 构建并推送镜像 (固定标签为 v1.0)
      - name: Build and Push Docker image
        run: |
          # 定义镜像变量，确保路径和标签与 Render 一致
          IMAGE_NAME=ghcr.io/${{ github.repository_owner }}/javasprint5_1blackjack:v1.0
          
          echo "Building image $IMAGE_NAME..."
          docker build -t $IMAGE_NAME .
          
          echo "Pushing image to GHCR..."
          docker push $IMAGE_NAME

      # 4. 通知 Render 进行部署
      - name: Deploy to Render
        env:
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        run: |
          echo "Triggering Render deployment for v1.0..."
          curl -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Accept: application/json" \
            -H "Content-Type: application/json" \
            -d '{"clearCache": "clear"}'