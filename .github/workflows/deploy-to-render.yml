
  name: Deploy Blackjack to Render

  on:
    push:
      branches:
        - main

  jobs:
    build-and-deploy:
      runs-on: ubuntu-latest
      permissions:
        contents: read
        packages: write

      steps:

        - name: Checkout repository
          uses: actions/checkout@v3


        - name: Set up JDK 23
          uses: actions/setup-java@v3
          with:
            java-version: '23'
            distribution: 'temurin'
            cache: maven


        - name: Build with Maven
          run: mvn clean package -DskipTests


        - name: Log in to GitHub Container Registry
          uses: docker/login-action@v2
          with:
            registry: ghcr.io
            username: ${{ github.repository_owner }}
            password: ${{ secrets.GITHUB_TOKEN }}


        - name: Build and Push Docker image
          run: |
            # Use lowercase for repository owner to avoid Docker tag issues
            OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
            IMAGE_NAME=ghcr.io/$OWNER_LOWER/javasprint5_1blackjack:v1.0
            
            echo "Building image $IMAGE_NAME..."
            docker build -t $IMAGE_NAME .
            
            echo "Pushing image to GHCR..."
            docker push $IMAGE_NAME
        

        - name: Deploy to Render
          env:
            RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
            RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          run: |
            echo "Triggering Render deployment for v1.0..."
            curl -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
              -H "Authorization: Bearer $RENDER_API_KEY" \
              -H "Accept: application/json" \
              -H "Content-Type: application/json" \
              -d '{"clearCache": "clear"}'